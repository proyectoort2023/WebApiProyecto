@page "/ORGANIZADOR/Mercadopago"
@layout LayoutVacio
@inject IConfiguration _config
@inject NavigationManager _nav
@inject MedioPagoServicio _servicioMedioPago
@inject UsuarioServicio _servicioUsuario
@inject ILocalStorageService _localStorage
@using System.Threading;


<h3>@mensaje</h3>


@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string code { get; set; }

    private string mensaje ="";

    protected async override Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(code))
        {
            await AsignarVendedorMakertPlace();
        }
    }



    private async Task AsignarVendedorMakertPlace()
    {
        try
        {
            var usuarioLogueado = await _localStorage.GetItemAsync<UsuarioLogueado>(Util.TOKEN_LOCAL);

            mensaje = usuarioLogueado.Id.ToString();
            _servicioUsuario.ActualizarUsuarioLogueado(usuarioLogueado);

            bool tokenVendedorGuardado = await _servicioMedioPago.ImplementarMercadoPagoVendedor(code, usuarioLogueado.Id, usuarioLogueado.Token);

            if (tokenVendedorGuardado)
            {
                mensaje = "Guardado correctamente. Redireccionando...";
                await _localStorage.RemoveItemAsync(Util.HABILITACION_MARKETPLACE);
            }
            else
            {
                mensaje = "hubo un error";
            }
            Thread.Sleep(3000);
            NavegarPrincipal();
        }
        catch (Exception ex)
        {

            mensaje = ex.Message;
        }
    }

    private void NavegarPrincipal()
    {
        _nav.NavigateTo("/", true);
    }


}
